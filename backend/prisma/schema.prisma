// Schéma Prisma pour l'Application d'Agenda Juridique

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// UTILISATEUR & AUTHENTIFICATION
// ============================================

enum RoleUtilisateur {
  ADMIN
  COLLABORATEUR
}

model Utilisateur {
  id        String           @id @default(uuid())
  email     String           @unique
  motDePasse String
  nomComplet String
  role      RoleUtilisateur  @default(COLLABORATEUR)
  estActif  Boolean          @default(true)
  
  // Sécurité
  refreshToken          String?   @db.Text
  refreshTokenExpiresAt DateTime?
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?
  lastLoginAt           DateTime?
  lastLoginIp           String?
  lastLoginUserAgent    String?   @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  affairesCrees     Affaire[]        @relation("CreateurAffaire")
  audiencesCrees    Audience[]       @relation("CreateurAudience")
  resultatsCrees    ResultatAudience[] @relation("CreateurResultat")
  journalAudit      JournalAudit[]
  
  @@map("utilisateurs")
}

// ============================================
// AFFAIRE
// ============================================

enum StatutAffaire {
  ACTIVE
  CLOTUREE
  RADIEE
}

model Affaire {
  id          String        @id @default(uuid())
  reference   String        @unique // AFF-2026-0001
  titre       String        // X c/ Y - expulsion
  juridiction String
  chambre     String
  ville       String?
  statut      StatutAffaire @default(ACTIVE)
  observations String?      @db.Text
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createurId  String
  createur    Utilisateur   @relation("CreateurAffaire", fields: [createurId], references: [id])
  
  // Relations
  parties     Partie[]
  audiences   Audience[]
  
  @@map("affaires")
  @@index([statut])
  @@index([reference])
}

// ============================================
// PARTIE
// ============================================

enum RolePartie {
  DEMANDEUR
  DEFENDEUR
  CONSEIL_ADVERSE
}

model Partie {
  id        String     @id @default(uuid())
  nom       String
  role      RolePartie
  
  affaireId String
  affaire   Affaire    @relation(fields: [affaireId], references: [id], onDelete: Cascade)
  
  @@map("parties")
  @@index([affaireId])
}

// ============================================
// AUDIENCE
// ============================================

enum StatutAudience {
  A_VENIR
  TENUE
  NON_RENSEIGNEE
}

enum TypeAudience {
  MISE_EN_ETAT
  PLAIDOIRIE
  REFERE
  EVOCATION
  CONCILIATION
  MEDIATION
  AUTRE
}

model Audience {
  id                String         @id @default(uuid())
  date              DateTime
  heure             String?
  type              TypeAudience
  statut            StatutAudience @default(A_VENIR)
  notesPreparation  String?        @db.Text
  estPreparee       Boolean        @default(false)
  
  affaireId         String
  affaire           Affaire        @relation(fields: [affaireId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  createurId        String
  createur          Utilisateur    @relation("CreateurAudience", fields: [createurId], references: [id])
  
  // Relations
  resultat          ResultatAudience?
  alertes           Alerte[]
  
  @@map("audiences")
  @@index([affaireId])
  @@index([date])
  @@index([statut])
}

// ============================================
// RÉSULTAT D'AUDIENCE
// ============================================

enum TypeResultat {
  RENVOI
  RADIATION
  DELIBERE
}

model ResultatAudience {
  id                String       @id @default(uuid())
  type              TypeResultat
  
  // Pour RENVOI
  nouvelleDate      DateTime?
  motifRenvoi       String?      @db.Text
  
  // Pour RADIATION
  motifRadiation    String?      @db.Text
  
  // Pour DELIBERE
  texteDelibere     String?      @db.Text
  
  audienceId        String       @unique
  audience          Audience     @relation(fields: [audienceId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime     @default(now())
  createurId        String
  createur          Utilisateur  @relation("CreateurResultat", fields: [createurId], references: [id])
  
  @@map("resultats_audience")
  @@index([audienceId])
}

// ============================================
// SYSTÈME D'ALERTES
// ============================================

enum StatutAlerte {
  EN_ATTENTE
  ENVOYEE
  RESOLUE
}

model Alerte {
  id              String        @id @default(uuid())
  audienceId      String
  audience        Audience      @relation(fields: [audienceId], references: [id], onDelete: Cascade)
  
  statut          StatutAlerte  @default(EN_ATTENTE)
  nombreEnvois    Int           @default(0)
  dernierEnvoiLe  DateTime?
  
  createdAt       DateTime      @default(now())
  resoleLe        DateTime?
  
  @@map("alertes")
  @@index([audienceId])
  @@index([statut])
}

// ============================================
// JOURNAL D'AUDIT (TRAÇABILITÉ)
// ============================================

enum ActionAudit {
  CREATION
  MODIFICATION
  SUPPRESSION
}

model JournalAudit {
  id              String      @id @default(uuid())
  typeEntite      String      // Affaire, Audience, ResultatAudience
  idEntite        String
  action          ActionAudit
  ancienneValeur  String?     @db.Text
  nouvelleValeur  String?     @db.Text
  
  utilisateurId   String
  utilisateur     Utilisateur @relation(fields: [utilisateurId], references: [id])
  
  createdAt       DateTime    @default(now())
  
  @@map("journal_audit")
  @@index([typeEntite, idEntite])
  @@index([utilisateurId])
  @@index([createdAt])
}

// ============================================
// CONFIGURATION SYSTÈME
// ============================================

model ConfigurationSysteme {
  id     String @id @default(uuid())
  cle    String @unique
  valeur String @db.Text
  
  updatedAt DateTime @updatedAt
  
  @@map("configuration_systeme")
}
